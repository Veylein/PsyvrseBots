import discord
from discord.ext import commands
from discord import app_commands
import random
import asyncio
from typing import Optional, Dict, List
import json
import os
from datetime import datetime, timedelta

class FishingAkinatorFun(commands.Cog):
    """Fishing, Akinator-style guessing, Drawing game, and enhanced fun commands"""
    
    def __init__(self, bot):
        self.bot = bot
        data_dir = os.getenv("RENDER_DISK_PATH", ".")
        self.fishing_data_file = os.path.join(data_dir, "fishing_data.json")
        self.fishing_data = self.load_fishing_data()
        self.active_akinator_games = {}
        self.active_drawing_games = {}
        self.active_riddles = {}  # Initialize riddles dict
        self.active_tournaments = {}
        
        # Fishing zones with unique fish
        self.fishing_zones = {
            "pond": {
                "name": "ğŸŒ¿ Peaceful Pond",
                "description": "A calm pond with common fish",
                "cost": 0,
                "fish": ["ğŸŸ", "ğŸ ", "ğŸ¦€", "ğŸš", "â­"]
            },
            "ocean": {
                "name": "ğŸŒŠ Deep Ocean",
                "description": "Venture into the ocean for better catches!",
                "cost": 50,
                "fish": ["ğŸ ", "ğŸ¡", "ğŸ¦ˆ", "ğŸ™", "ğŸ¦‘", "ğŸ¦", "ğŸª¸"]
            },
            "arctic": {
                "name": "â„ï¸ Arctic Waters",
                "description": "Cold waters with rare creatures",
                "cost": 100,
                "fish": ["ğŸ¦­", "ğŸ§", "ğŸ¦ˆ", "ğŸ³", "ğŸ’"]
            },
            "tropical": {
                "name": "ğŸï¸ Tropical Paradise",
                "description": "Exotic fish in paradise!",
                "cost": 75,
                "fish": ["ğŸ ", "ğŸ¡", "ğŸ¬", "ğŸ¦‘", "ğŸª¸", "ğŸ’"]
            },
            "abyss": {
                "name": "ğŸŒ‘ Dark Abyss",
                "description": "The deepest, most dangerous waters... legendary fish await!",
                "cost": 200,
                "fish": ["ğŸ¦‘", "ğŸ™", "ğŸ¦ˆ", "ğŸ³", "ğŸ’", "ğŸ‘‘"]
            }
        }
        
        # Equipment upgrades
        self.fishing_equipment = {
            "basic_rod": {"name": "Basic Rod", "bonus": 0, "cost": 0},
            "pro_rod": {"name": "Pro Rod", "bonus": 10, "cost": 500},
            "master_rod": {"name": "Master Rod", "bonus": 25, "cost": 2000},
            "legendary_rod": {"name": "Legendary Rod", "bonus": 50, "cost": 10000}
        }
        
        # Fish types with rarity and value
        self.fish_types = {
            "ğŸŸ": {"name": "Common Fish", "rarity": "Common", "value": 10, "chance": 50},
            "ğŸ ": {"name": "Tropical Fish", "rarity": "Common", "value": 15, "chance": 30},
            "ğŸ¡": {"name": "Pufferfish", "rarity": "Uncommon", "value": 30, "chance": 15},
            "ğŸ¦ˆ": {"name": "Shark", "rarity": "Rare", "value": 75, "chance": 8},
            "ğŸ™": {"name": "Octopus", "rarity": "Rare", "value": 100, "chance": 5},
            "ğŸ¦‘": {"name": "Squid", "rarity": "Rare", "value": 90, "chance": 6},
            "ğŸ¬": {"name": "Dolphin", "rarity": "Epic", "value": 200, "chance": 3},
            "ğŸ³": {"name": "Whale", "rarity": "Epic", "value": 300, "chance": 2},
            "ğŸ¦­": {"name": "Seal", "rarity": "Uncommon", "value": 50, "chance": 10},
            "ğŸ¦€": {"name": "Crab", "rarity": "Common", "value": 20, "chance": 25},
            "ğŸ¦": {"name": "Lobster", "rarity": "Uncommon", "value": 60, "chance": 12},
            "ğŸš": {"name": "Shell", "rarity": "Common", "value": 5, "chance": 40},
            "â­": {"name": "Starfish", "rarity": "Uncommon", "value": 40, "chance": 15},
            "ğŸª¸": {"name": "Coral", "rarity": "Rare", "value": 80, "chance": 7},
            "ğŸ§": {"name": "Penguin", "rarity": "Rare", "value": 120, "chance": 5},
            "ğŸ’": {"name": "Treasure", "rarity": "Legendary", "value": 1000, "chance": 0.5},
            "ğŸ‘‘": {"name": "Crown", "rarity": "Legendary", "value": 2000, "chance": 0.1},
        }
        
        # Akinator character database
        self.akinator_characters = [
            {"name": "Pikachu", "category": "Pokemon", "hints": ["electric", "yellow", "anime", "mouse", "games"]},
            {"name": "Mario", "category": "Video Games", "hints": ["italian", "red", "plumber", "mushrooms", "nintendo"]},
            {"name": "Harry Potter", "category": "Books/Movies", "hints": ["wizard", "glasses", "scar", "hogwarts", "british"]},
            {"name": "Spider-Man", "category": "Comics", "hints": ["superhero", "web", "marvel", "red", "teenage"]},
            {"name": "Sonic", "category": "Video Games", "hints": ["fast", "blue", "hedgehog", "rings", "sega"]},
            {"name": "Batman", "category": "Comics", "hints": ["dark", "rich", "gotham", "dc", "cape"]},
            {"name": "Elsa", "category": "Movies", "hints": ["ice", "frozen", "disney", "queen", "sister"]},
            {"name": "Link", "category": "Video Games", "hints": ["green", "sword", "zelda", "elf", "hero"]},
            {"name": "Darth Vader", "category": "Movies", "hints": ["dark", "star wars", "force", "father", "mask"]},
            {"name": "Iron Man", "category": "Comics", "hints": ["tech", "red", "marvel", "billionaire", "suit"]},
        ]
        
        # Fun facts database
        self.fun_facts = [
            "Honey never spoils! Archaeologists have found 3000-year-old honey that's still edible.",
            "A group of flamingos is called a 'flamboyance'!",
            "Octopuses have three hearts!",
            "Bananas are berries, but strawberries aren't!",
            "The shortest war in history lasted 38-45 minutes.",
            "Sharks existed before trees!",
            "A day on Venus is longer than its year!",
            "Wombat poop is cube-shaped!",
            "Sea otters hold hands when they sleep!",
            "Penguins propose to their mates with pebbles!",
        ]
        
        # Riddles database
        self.riddles = [
            {"question": "I speak without a mouth and hear without ears. I have no body, but come alive with wind. What am I?", "answer": "echo"},
            {"question": "The more you take, the more you leave behind. What am I?", "answer": "footsteps"},
            {"question": "I have cities, but no houses. I have mountains, but no trees. I have water, but no fish. What am I?", "answer": "map"},
            {"question": "What has hands but cannot clap?", "answer": "clock"},
            {"question": "What gets wet while drying?", "answer": "towel"},
            {"question": "I'm tall when I'm young and short when I'm old. What am I?", "answer": "candle"},
            {"question": "What has a head and tail but no body?", "answer": "coin"},
            {"question": "What can travel around the world while staying in a corner?", "answer": "stamp"},
            {"question": "What has many keys but can't open a lock?", "answer": "piano"},
            {"question": "What comes once in a minute, twice in a moment, but never in a thousand years?", "answer": "letter m"},
        ]
        
        # Jokes database
        self.jokes = [
            "Why don't scientists trust atoms? Because they make up everything!",
            "What do you call a bear with no teeth? A gummy bear!",
            "Why did the scarecrow win an award? He was outstanding in his field!",
            "What do you call cheese that isn't yours? Nacho cheese!",
            "Why don't eggs tell jokes? They'd crack each other up!",
            "What's orange and sounds like a parrot? A carrot!",
            "Why don't skeletons fight each other? They don't have the guts!",
            "What did one wall say to the other? I'll meet you at the corner!",
            "Why did the bicycle fall over? It was two-tired!",
            "What do you call a fake noodle? An impasta!",
        ]
        
        # Drawing words
        self.drawing_words = {
            "easy": ["cat", "dog", "sun", "tree", "house", "car", "fish", "bird", "flower", "star"],
            "medium": ["dragon", "castle", "robot", "unicorn", "pizza", "guitar", "rocket", "crown", "rainbow", "mountain"],
            "hard": ["lighthouse", "helicopter", "skateboard", "microscope", "astronaut", "dinosaur", "submarine", "pyramid", "volcano", "telescope"]
        }
    
    def load_fishing_data(self):
        """Load fishing data from JSON file"""
        if not os.path.exists(self.fishing_data_file):
            # Create file with empty data if it doesn't exist
            empty_data = {}
            with open(self.fishing_data_file, 'w') as f:
                json.dump(empty_data, f, indent=4)
            return empty_data
        
        try:
            with open(self.fishing_data_file, 'r') as f:
                return json.load(f)
        except json.JSONDecodeError:
            print(f"âš ï¸ Warning: {self.fishing_data_file} is corrupted, creating new file")
            return {}
        except Exception as e:
            print(f"âŒ Error loading fishing data: {e}")
            return {}
    
    def save_fishing_data(self):
        """Save fishing data to JSON file"""
        try:
            with open(self.fishing_data_file, 'w') as f:
                json.dump(self.fishing_data, f, indent=4)
        except Exception as e:
            print(f"âŒ Error saving fishing data: {e}")
    
    def get_user_fishing_data(self, user_id):
        """Get user's fishing data"""
        user_id = str(user_id)
        if user_id not in self.fishing_data:
            self.fishing_data[user_id] = {
                "catches": {},
                "total_caught": 0,
                "total_value": 0,
                "last_fish": None,
                "equipment": "basic_rod",
                "current_zone": "pond"
            }
        # Ensure new fields exist for existing users
        if "equipment" not in self.fishing_data[user_id]:
            self.fishing_data[user_id]["equipment"] = "basic_rod"
        if "current_zone" not in self.fishing_data[user_id]:
            self.fishing_data[user_id]["current_zone"] = "pond"
        return self.fishing_data[user_id]
    
    # ==================== FISHING ====================
    
    @app_commands.command(name="fish", description="Fishing game - cast, view aquarium, sell, and more!")
    @app_commands.describe(
        action="What do you want to do?",
        zone="Fishing zone (for zone action)",
        rod="Rod type (for buyrod action)",
        user="User to view (for aquarium action)",
        duration="Tournament duration in minutes 5-30 (for tournament action)"
    )
    @app_commands.choices(action=[
        app_commands.Choice(name="ğŸ£ Cast Line", value="cast"),
        app_commands.Choice(name="ğŸ  View Aquarium", value="aquarium"),
        app_commands.Choice(name="ğŸ’° Sell Fish", value="sell"),
        app_commands.Choice(name="ğŸ—ºï¸ View Zones", value="zones"),
        app_commands.Choice(name="ğŸŒŠ Fish in Zone", value="zone"),
        app_commands.Choice(name="ğŸ£ View Rod", value="rod"),
        app_commands.Choice(name="ğŸ›’ Buy Rod", value="buyrod"),
        app_commands.Choice(name="ğŸ† Start Tournament", value="tournament"),
    ])
    async def fish_command(
        self, 
        interaction: discord.Interaction, 
        action: str,
        zone: Optional[str] = None,
        rod: Optional[str] = None,
        user: Optional[discord.Member] = None,
        duration: Optional[int] = 10
    ):
        """Unified fishing command"""
        if action == "cast":
            await self.fish_cast_action(interaction)
        elif action == "aquarium":
            await self.fish_aquarium_action(interaction, user)
        elif action == "sell":
            await self.fish_sell_action(interaction)
        elif action == "zones":
            await self.fish_zones_action(interaction)
        elif action == "zone":
            await self.fish_in_zone_action(interaction, zone)
        elif action == "rod":
            await self.fish_rod_action(interaction)
        elif action == "buyrod":
            await self.fish_buy_rod_action(interaction, rod)
        elif action == "tournament":
            await self.fish_tournament_action(interaction, duration)
    
    async def fish_cast_action(self, interaction: discord.Interaction):
        """Go fishing"""
        user_data = self.get_user_fishing_data(interaction.user.id)
        
        # Check cooldown (30 seconds)
        if user_data["last_fish"]:
            last_time = datetime.fromisoformat(user_data["last_fish"])
            if datetime.now() - last_time < timedelta(seconds=30):
                remaining = 30 - (datetime.now() - last_time).seconds
                await interaction.response.send_message(
                    f"ğŸ£ Your fishing line needs to settle! Wait {remaining} seconds.",
                    ephemeral=True
                )
                return
        
        # Determine what was caught
        roll = random.random() * 100
        cumulative_chance = 0
        caught_fish = None
        
        for emoji, fish_data in self.fish_types.items():
            cumulative_chance += fish_data["chance"]
            if roll <= cumulative_chance:
                caught_fish = (emoji, fish_data)
                break
        
        if not caught_fish:
            caught_fish = ("ğŸŸ", self.fish_types["ğŸŸ"])
        
        emoji, fish_info = caught_fish
        
        # Add to inventory
        user_data["catches"][emoji] = user_data["catches"].get(emoji, 0) + 1
        user_data["total_caught"] += 1
        user_data["total_value"] += fish_info["value"]
        user_data["last_fish"] = datetime.now().isoformat()
        
        # Track tournament participation
        guild_id = str(interaction.guild.id) if interaction.guild else None
        if guild_id and guild_id in self.active_tournaments:
            user_id = str(interaction.user.id)
            self.active_tournaments[guild_id]["participants"][user_id] = \
                self.active_tournaments[guild_id]["participants"].get(user_id, 0) + fish_info["value"]
        
        self.save_fishing_data()
        
        # Create embed
        rarity_colors = {
            "Common": discord.Color.light_gray(),
            "Uncommon": discord.Color.green(),
            "Rare": discord.Color.blue(),
            "Epic": discord.Color.purple(),
            "Legendary": discord.Color.gold()
        }
        
        tournament_note = "\nğŸ† **Tournament points added!**" if (guild_id and guild_id in self.active_tournaments) else ""
        
        embed = discord.Embed(
            title="ğŸ£ Fishing Success!",
            description=f"You caught a **{fish_info['name']}** {emoji}!\n\n"
                       f"**Rarity:** {fish_info['rarity']}\n"
                       f"**Value:** {fish_info['value']} PsyCoins{tournament_note}\n\n"
                       f"Use `/fish aquarium` to see your collection!\n"
                       f"Use `/fish sell` to sell your catches!",
            color=rarity_colors[fish_info['rarity']]
        )
        
        await interaction.response.send_message(embed=embed)
    
    async def fish_aquarium_action(self, interaction: discord.Interaction, user: Optional[discord.Member] = None):
        """View fish collection"""
        target = user or interaction.user
        user_data = self.get_user_fishing_data(target.id)
        
        if not user_data["catches"]:
            await interaction.response.send_message(
                f"{'You have' if target == interaction.user else f'{target.display_name} has'} not caught any fish yet!",
                ephemeral=True
            )
            return
        
        # Display collection
        collection_lines = []
        for emoji, count in sorted(user_data["catches"].items(), key=lambda x: -x[1]):
            fish_info = self.fish_types[emoji]
            total_value = count * fish_info["value"]
            collection_lines.append(f"{emoji} **{fish_info['name']}** x{count} ({fish_info['rarity']}) - {total_value} coins")
        
        embed = discord.Embed(
            title=f"ğŸ  {target.display_name}'s Aquarium",
            description="\n".join(collection_lines[:15]),
            color=discord.Color.blue()
        )
        embed.add_field(name="Total Caught", value=user_data["total_caught"], inline=True)
        embed.add_field(name="Collection Value", value=f"{user_data['total_value']} PsyCoins", inline=True)
        embed.add_field(name="Unique Fish", value=len(user_data["catches"]), inline=True)
        
        await interaction.response.send_message(embed=embed)
    
    async def fish_sell_action(self, interaction: discord.Interaction):
        """Sell all fish"""
        user_data = self.get_user_fishing_data(interaction.user.id)
        
        if not user_data["catches"]:
            await interaction.response.send_message("ğŸŸ You have no fish to sell!", ephemeral=True)
            return
        
        total_value = user_data["total_value"]
        total_fish = sum(user_data["catches"].values())
        
        # Add coins
        economy_cog = self.bot.get_cog("Economy")
        if economy_cog:
            economy_cog.add_coins(interaction.user.id, total_value, "fishing")
        
        # Clear catches but keep total_caught
        user_data["catches"] = {}
        user_data["total_value"] = 0
        self.save_fishing_data()
        
        embed = discord.Embed(
            title="ğŸ’° Fish Sold!",
            description=f"You sold **{total_fish} fish** for **{total_value} PsyCoins**!",
            color=discord.Color.gold()
        )
        
        await interaction.response.send_message(embed=embed)
    
    async def fish_zones_action(self, interaction: discord.Interaction):
        """List all fishing zones"""
        embed = discord.Embed(
            title="ğŸ—ºï¸ Fishing Zones",
            description="Travel to different zones for unique fish!",
            color=discord.Color.blue()
        )
        
        for zone_id, zone in self.fishing_zones.items():
            fish_list = " ".join(zone["fish"][:5])
            embed.add_field(
                name=f"{zone['name']}",
                value=f"{zone['description']}\n"
                      f"**Entry Fee:** {zone['cost']} coins\n"
                      f"**Fish:** {fish_list}\n"
                      f"Use `/fishzone {zone_id}`",
                inline=False
            )
        
        await interaction.response.send_message(embed=embed)
    
    async def fish_in_zone_action(self, interaction: discord.Interaction, zone: Optional[str] = None):
        """Fish in a specific zone"""
        if not zone:
            await interaction.response.send_message("âŒ Please specify a zone! Use `/fish zones` to see all zones.", ephemeral=True)
            return
            
        if zone.lower() not in self.fishing_zones:
            await interaction.response.send_message(
                "âŒ Invalid zone! Use `/fish zones` to see all zones.",
                ephemeral=True
            )
            return
        
        zone_data = self.fishing_zones[zone.lower()]
        user_data = self.get_user_fishing_data(interaction.user.id)
        
        # Check cooldown
        if user_data["last_fish"]:
            last_time = datetime.fromisoformat(user_data["last_fish"])
            if datetime.now() - last_time < timedelta(seconds=30):
                remaining = 30 - (datetime.now() - last_time).seconds
                await interaction.response.send_message(
                    f"ğŸ£ Your fishing line needs to settle! Wait {remaining} seconds.",
                    ephemeral=True
                )
                return
        
        # Check if user can afford entry fee
        if zone_data["cost"] > 0:
            economy_cog = self.bot.get_cog("Economy")
            if economy_cog:
                balance = economy_cog.get_balance(interaction.user.id)
                if balance < zone_data["cost"]:
                    await interaction.response.send_message(
                        f"âŒ You need {zone_data['cost']} PsyCoins to enter {zone_data['name']}!",
                        ephemeral=True
                    )
                    return
                economy_cog.remove_coins(interaction.user.id, zone_data["cost"], "fishing_zone_fee")
        
        # Get equipment bonus
        rod = user_data.get("equipment", "basic_rod")
        equipment_bonus = self.fishing_equipment[rod]["bonus"]
        
        # Determine what was caught (only from zone's fish pool)
        zone_fish = {emoji: self.fish_types[emoji] for emoji in zone_data["fish"]}
        
        roll = random.random() * 100 + equipment_bonus  # Equipment increases chances
        cumulative_chance = 0
        caught_fish = None
        
        for emoji, fish_data in zone_fish.items():
            cumulative_chance += fish_data["chance"]
            if roll <= cumulative_chance:
                caught_fish = (emoji, fish_data)
                break
        
        if not caught_fish:
            caught_fish = random.choice(list(zone_fish.items()))
        
        emoji, fish_info = caught_fish
        
        # Add to inventory
        user_data["catches"][emoji] = user_data["catches"].get(emoji, 0) + 1
        user_data["total_caught"] += 1
        user_data["total_value"] += fish_info["value"]
        user_data["last_fish"] = datetime.now().isoformat()
        user_data["current_zone"] = zone.lower()
        
        self.save_fishing_data()
        
        # Create embed
        rarity_colors = {
            "Common": discord.Color.light_gray(),
            "Uncommon": discord.Color.green(),
            "Rare": discord.Color.blue(),
            "Epic": discord.Color.purple(),
            "Legendary": discord.Color.gold()
        }
        
        embed = discord.Embed(
            title=f"ğŸ£ {zone_data['name']}",
            description=f"You caught a **{fish_info['name']}** {emoji}!\n\n"
                       f"**Rarity:** {fish_info['rarity']}\n"
                       f"**Value:** {fish_info['value']} PsyCoins\n"
                       f"**Equipment:** {self.fishing_equipment[rod]['name']} (+{equipment_bonus}% rare fish)\n\n"
                       f"Use `/fish aquarium` to see your collection!",
            color=rarity_colors[fish_info['rarity']]
        )
        
        await interaction.response.send_message(embed=embed)
    
    async def fish_rod_action(self, interaction: discord.Interaction):
        """View fishing rod"""
        user_data = self.get_user_fishing_data(interaction.user.id)
        current_rod = user_data.get("equipment", "basic_rod")
        
        embed = discord.Embed(
            title="ğŸ£ Your Fishing Equipment",
            description=f"**Current Rod:** {self.fishing_equipment[current_rod]['name']}\n"
                       f"**Bonus:** +{self.fishing_equipment[current_rod]['bonus']}% rare fish chance",
            color=discord.Color.blue()
        )
        
        embed.add_field(
            name="Available Upgrades",
            value="\n".join([
                f"**{equip['name']}** - +{equip['bonus']}% bonus - {equip['cost']} coins"
                for rod_id, equip in self.fishing_equipment.items()
                if rod_id != current_rod
            ]),
            inline=False
        )
        
        embed.set_footer(text="Use /fish buyrod <rod_name> to upgrade!")
        
        await interaction.response.send_message(embed=embed)
    
    async def fish_buy_rod_action(self, interaction: discord.Interaction, rod: Optional[str] = None):
        """Buy fishing rod"""
        if not rod:
            await interaction.response.send_message("âŒ Please specify a rod! Use `/fish rod` to see options.", ephemeral=True)
            return
            
        if rod.lower() not in self.fishing_equipment:
            await interaction.response.send_message("âŒ Invalid rod! Use `/fish rod` to see options.", ephemeral=True)
            return
        
        rod_data = self.fishing_equipment[rod.lower()]
        user_data = self.get_user_fishing_data(interaction.user.id)
        current_rod = user_data.get("equipment", "basic_rod")
        
        if rod.lower() == current_rod:
            await interaction.response.send_message("âŒ You already have this rod!", ephemeral=True)
            return
        
        economy_cog = self.bot.get_cog("Economy")
        if economy_cog:
            balance = economy_cog.get_balance(interaction.user.id)
            if balance < rod_data["cost"]:
                await interaction.response.send_message(
                    f"âŒ You need {rod_data['cost']} PsyCoins to buy the {rod_data['name']}!",
                    ephemeral=True
                )
                return
            
            economy_cog.remove_coins(interaction.user.id, rod_data["cost"], "fishing_rod_purchase")
        
        user_data["equipment"] = rod.lower()
        self.save_fishing_data()
        
        embed = discord.Embed(
            title="ğŸ‰ Rod Upgraded!",
            description=f"You bought the **{rod_data['name']}**!\n\n"
                       f"**Bonus:** +{rod_data['bonus']}% rare fish chance\n\n"
                       f"Go catch some legendary fish!",
            color=discord.Color.gold()
        )
        
        await interaction.response.send_message(embed=embed)
    
    async def fish_tournament_action(self, interaction: discord.Interaction, duration: int = 10):
        """Start fishing tournament"""
        if not interaction.user.guild_permissions.manage_guild:
            await interaction.response.send_message(
                "âŒ Only server managers can start tournaments!",
                ephemeral=True
            )
            return
        
        if duration < 5 or duration > 30:
            await interaction.response.send_message(
                "âŒ Duration must be between 5-30 minutes!",
                ephemeral=True
            )
            return
        
        guild_id = str(interaction.guild.id)
        if guild_id in self.active_tournaments:
            await interaction.response.send_message(
                "âŒ A tournament is already running in this server!",
                ephemeral=True
            )
            return
        
        end_time = datetime.now() + timedelta(minutes=duration)
        self.active_tournaments[guild_id] = {
            "end_time": end_time.isoformat(),
            "participants": {},
            "started_by": interaction.user.id
        }
        
        embed = discord.Embed(
            title="ğŸ† FISHING TOURNAMENT STARTED!",
            description=f"**Duration:** {duration} minutes\n"
                       f"**Ends:** <t:{int(end_time.timestamp())}:R>\n\n"
                       f"ğŸ£ Use `/fish cast` or `/fish zone` to participate!\n"
                       f"ğŸ† Highest total value wins!\n"
                       f"ğŸ’° Winner gets bonus PsyCoins!",
            color=discord.Color.gold()
        )
        
        await interaction.response.send_message(embed=embed)
        
        # Schedule tournament end
        await asyncio.sleep(duration * 60)
        
        if guild_id in self.active_tournaments:
            tournament = self.active_tournaments[guild_id]
            if not tournament["participants"]:
                await interaction.followup.send("Tournament ended with no participants! ğŸ˜¢")
            else:
                # Find winner
                winner_id = max(tournament["participants"], key=lambda x: tournament["participants"][x])
                winner_value = tournament["participants"][winner_id]
                winner = await interaction.guild.fetch_member(int(winner_id))
                
                # Award prize
                prize = winner_value * 2
                economy_cog = self.bot.get_cog("Economy")
                if economy_cog:
                    economy_cog.add_coins(winner.id, prize, "fishing_tournament_win")
                
                # Display results
                leaderboard = sorted(tournament["participants"].items(), key=lambda x: -x[1])[:5]
                leaderboard_text = "\n".join([
                    f"{i+1}. <@{user_id}> - {value} value"
                    for i, (user_id, value) in enumerate(leaderboard)
                ])
                
                embed = discord.Embed(
                    title="ğŸ† TOURNAMENT COMPLETE!",
                    description=f"**Winner:** {winner.mention}\n"
                               f"**Total Value:** {winner_value} coins\n"
                               f"**Prize:** {prize} PsyCoins!\n\n"
                               f"**Top 5:**\n{leaderboard_text}",
                    color=discord.Color.gold()
                )
                
                await interaction.followup.send(embed=embed)
            
            del self.active_tournaments[guild_id]
    
    # ==================== AKINATOR-STYLE GUESSING ====================
    
    @app_commands.command(name="akinator", description="Mind-reading guessing game!")
    @app_commands.describe(action="What do you want to do?")
    @app_commands.choices(action=[
        app_commands.Choice(name="ğŸ”® Start Game", value="start"),
        app_commands.Choice(name="âœ… Answer YES", value="yes"),
        app_commands.Choice(name="âŒ Answer NO", value="no"),
    ])
    async def akinator_command(self, interaction: discord.Interaction, action: str):
        """Unified akinator command"""
        if action == "start":
            await self.akinator_start_action(interaction)
        elif action == "yes":
            await self.akinator_yes_action(interaction)
        elif action == "no":
            await self.akinator_no_action(interaction)
    
    async def akinator_start_action(self, interaction: discord.Interaction):
        """Start Akinator game"""
        game_id = str(interaction.user.id)
        
        if game_id in self.active_akinator_games:
            await interaction.response.send_message("âŒ You already have an active Akinator game!", ephemeral=True)
            return
        
        # Pick a character to guess
        character = random.choice(self.akinator_characters)
        
        self.active_akinator_games[game_id] = {
            "character": character,
            "questions_asked": 0,
            "hints_given": [],
            "guessed": False
        }
        
        embed = discord.Embed(
            title="ğŸ”® Akinator - Guess Your Character!",
            description="Think of a character (real or fictional) and I'll try to guess it!\n\n"
                       "I'll ask you questions. Answer with `/akinator yes` or `/akinator no`\n\n"
                       "**Question 1:** Is your character from a video game?",
            color=discord.Color.purple()
        )
        
        await interaction.response.send_message(embed=embed)
    
    async def akinator_yes_action(self, interaction: discord.Interaction):
        """Answer yes"""
        await self.process_akinator_answer(interaction, True)
    
    async def akinator_no_action(self, interaction: discord.Interaction):
        """Answer no"""
        await self.process_akinator_answer(interaction, False)
    
    async def process_akinator_answer(self, interaction, answer: bool):
        """Process Akinator answer"""
        game_id = str(interaction.user.id)
        
        if game_id not in self.active_akinator_games:
            await interaction.response.send_message("âŒ No active Akinator game! Start one with `/akinator start`", ephemeral=True)
            return
        
        game = self.active_akinator_games[game_id]
        game["questions_asked"] += 1
        
        # After 5 questions, make a guess
        if game["questions_asked"] >= 5:
            character = game["character"]
            
            embed = discord.Embed(
                title="ğŸ”® Akinator's Guess!",
                description=f"I think you're thinking of...\n\n"
                           f"**{character['name']}** from {character['category']}!\n\n"
                           f"Was I right? React with âœ… or âŒ",
                color=discord.Color.gold()
            )
            
            msg = await interaction.response.send_message(embed=embed)
            await msg.add_reaction("âœ…")
            await msg.add_reaction("âŒ")
            
            # Award coins if correct
            economy_cog = self.bot.get_cog("Economy")
            if economy_cog:
                economy_cog.add_coins(interaction.user.id, 50, "akinator")
            
            del self.active_akinator_games[game_id]
        else:
            # Ask another question
            questions = [
                "Is your character a hero?",
                "Is your character from a movie or TV show?",
                "Does your character have special powers?",
                "Is your character an animal?",
                "Is your character from Japan?",
            ]
            
            next_question = questions[game["questions_asked"] % len(questions)]
            
            embed = discord.Embed(
                title="ğŸ”® Akinator",
                description=f"**Question {game['questions_asked'] + 1}:** {next_question}",
                color=discord.Color.purple()
            )
            
            await interaction.response.send_message(embed=embed)
    
    # ==================== DRAWING GAME ====================
    
    @app_commands.command(name="draw", description="Drawing game - describe what you see!")
    async def draw(self, interaction: discord.Interaction, difficulty: str = "medium"):
        """Start drawing game"""
        game_id = f"{interaction.guild.id}_{interaction.channel.id}_draw"
        
        if game_id in self.active_drawing_games:
            await interaction.response.send_message("âŒ There's already a drawing game in this channel!", ephemeral=True)
            return
        
        # Pick a word
        difficulty = difficulty.lower()
        if difficulty not in self.drawing_words:
            difficulty = "medium"
        
        word = random.choice(self.drawing_words[difficulty])
        
        # Create ASCII/emoji representation hints
        hints = {
            "cat": "ğŸ± = /\\_/\\ \n( o.o )\n > ^ <",
            "dog": "ğŸ¶ = /^--^\\ \n/ o  o \\ \n\\_____/",
            "sun": "â˜€ï¸ =   \\|/  \n  -O-  \n  /|\\",
            "default": "ğŸ¨ A simple drawing"
        }
        
        hint = hints.get(word, hints["default"])
        
        self.active_drawing_games[game_id] = {
            "word": word,
            "difficulty": difficulty,
            "starter": interaction.user,
            "guesses": 0,
            "max_guesses": 3
        }
        
        embed = discord.Embed(
            title="ğŸ¨ Drawing Game!",
            description=f"{interaction.user.mention} started a drawing game!\n\n"
                       f"**Difficulty:** {difficulty.title()}\n\n"
                       f"```{hint}```\n\n"
                       f"Guess the word with `/guess <word>`!",
            color=discord.Color.orange()
        )
        
        await interaction.response.send_message(embed=embed)
    
    @app_commands.command(name="guess", description="Guess the drawing")
    async def guess_drawing(self, interaction: discord.Interaction, word: str):
        """Guess the drawing"""
        game_id = f"{interaction.guild.id}_{interaction.channel.id}_draw"
        
        if game_id not in self.active_drawing_games:
            await interaction.response.send_message("âŒ No active drawing game!", ephemeral=True)
            return
        
        game = self.active_drawing_games[game_id]
        
        if word.lower() == game["word"]:
            # Correct guess!
            rewards = {"easy": 50, "medium": 100, "hard": 150}
            reward = rewards[game["difficulty"]]
            
            economy_cog = self.bot.get_cog("Economy")
            if economy_cog:
                economy_cog.add_coins(interaction.user.id, reward, "drawing_game")
            
            embed = discord.Embed(
                title="ğŸ¨ Correct!",
                description=f"ğŸ† {interaction.user.mention} guessed it!\n\n"
                           f"The word was: **{game['word']}**\n"
                           f"+{reward} PsyCoins!",
                color=discord.Color.green()
            )
            
            await interaction.response.send_message(embed=embed)
            del self.active_drawing_games[game_id]
        else:
            game["guesses"] += 1
            
            if game["guesses"] >= game["max_guesses"]:
                embed = discord.Embed(
                    title="ğŸ¨ Game Over!",
                    description=f"No more guesses! The word was: **{game['word']}**",
                    color=discord.Color.red()
                )
                await interaction.response.send_message(embed=embed)
                del self.active_drawing_games[game_id]
            else:
                await interaction.response.send_message(
                    f"âŒ Wrong! {game['max_guesses'] - game['guesses']} guesses left.",
                    ephemeral=True
                )
    
    # ==================== FUN COMMANDS ====================
    
    @app_commands.command(name="funfact", description="Get a random fun fact")
    async def funfact(self, interaction: discord.Interaction):
        """Random fun fact"""
        fact = random.choice(self.fun_facts)
        
        embed = discord.Embed(
            title="ğŸ’¡ Fun Fact!",
            description=fact,
            color=discord.Color.blue()
        )
        
        # Award small coins
        economy_cog = self.bot.get_cog("Economy")
        if economy_cog:
            economy_cog.add_coins(interaction.user.id, 5, "fun_fact")
        
        await interaction.response.send_message(embed=embed)
    
    @app_commands.command(name="riddler", description="Get a riddle to solve")
    async def riddler(self, interaction: discord.Interaction):
        """Random riddle"""
        riddle = random.choice(self.riddles)
        
        embed = discord.Embed(
            title="ğŸ¤” Riddle Time!",
            description=f"**{riddle['question']}**\n\nType `/riddleanswer <your answer>` to check!",
            color=discord.Color.purple()
        )
        
        # Store riddle for this user
        user_id = str(interaction.user.id)
        if not hasattr(self, 'active_riddles'):
            self.active_riddles = {}
        self.active_riddles[user_id] = riddle
        
        await interaction.response.send_message(embed=embed)
    
    @app_commands.command(name="riddleanswer", description="Answer a riddle")
    async def riddleanswer(self, interaction: discord.Interaction, answer: str):
        """Answer riddle"""
        user_id = str(interaction.user.id)
        
        if not hasattr(self, 'active_riddles') or user_id not in self.active_riddles:
            await interaction.response.send_message("âŒ No active riddle! Use `/riddle` first.", ephemeral=True)
            return
        
        riddle = self.active_riddles[user_id]
        
        if answer.lower().strip() in riddle["answer"].lower():
            economy_cog = self.bot.get_cog("Economy")
            if economy_cog:
                economy_cog.add_coins(interaction.user.id, 75, "riddle_solved")
            
            embed = discord.Embed(
                title="âœ… Correct!",
                description=f"The answer was: **{riddle['answer']}**\n\n+75 PsyCoins!",
                color=discord.Color.green()
            )
            
            del self.active_riddles[user_id]
            await interaction.response.send_message(embed=embed)
        else:
            await interaction.response.send_message("âŒ Wrong answer! Try again.", ephemeral=True)

async def setup(bot):
    await bot.add_cog(FishingAkinatorFun(bot))
